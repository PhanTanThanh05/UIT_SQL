CREATE DATABASE QuanLyBanHang
GO

USE QuanLyBanHang
GO

CREATE TABLE KHACHHANG
(
MAKH CHAR(4) primary key,
HOTEN varchar(40),
DCHI varchar(50),
SODT varchar(10),
NGSINH smalldatetime,
NGDK smalldatetime,
DOANHSO money,
);

CREATE TABLE NHANVIEN (
MANV CHAR(4) primary key,
HOTEN VARCHAR(40),
SODT VARCHAR(20),
NGVL smalldatetime,
);



CREATE TABLE SANPHAM(
MASP char(4) primary key,
TENSP varchar(40),
DVT varchar(20),
NUOCSX varchar(40),
GIA money,
);

CREATE TABLE HOADON ( 
SOHD int primary key,
NGHD smalldatetime,
MAKH char(4)FOREIGN KEY REFERENCES KHACHHANG(MAKH),
MANV char(4) FOREIGN KEY REFERENCES NHANVIEN(MANV),
TRIGIA money,
);

CREATE TABLE CTHD (
SOHD INT FOREIGN KEY REFERENCES HOADON(SOHD),
MASP char(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
SL INT CHECK(SL >= 1),
PRIMARY KEY(SOHD, MASP),
);

--I--
--2--
ALTER TABLE SANPHAM ADD GHICHU VARCHAR(20)

--3--
ALTER TABLE KHACHHANG ADD LOAIKH TINYINT

--4--
ALTER TABLE SANPHAM ALTER COLUMN GHICHU VARCHAR(100)

--5--
ALTER TABLE SANPHAM DROP COLUMN GHICHU

--6--
ALTER TABLE KHACHHANG ALTER COLUMN LOAIKH VARCHAR(20)
ALTER TABLE KHACHHANG ADD CONSTRAINT CHECK_LOAIKH CHECK(LOAIKH IN('Vang lai', 'Thuong xuyen', 'VIP'))

--7--
ALTER TABLE SANPHAM ADD CONSTRAINT CHECK_DVT CHECK(DVT IN('cay', 'hop', 'cai', 'quyen', 'chuc'))

--8--
ALTER TABLE SANPHAM ADD CONSTRAINT CHECK_GIA CHECK(GIA >= 500)

--9--
ALTER TABLE HOADON ADD CONSTRAINT CHECK_MUAHANG CHECK(TRIGIA > 0)

--10--
ALTER TABLE KHACHHANG ADD CONSTRAINT CHECK_NGAY CHECK(NGDK > NGSINH);

--11--
CREATE TRIGGER TRG_INS_NGHD 
ON dbo.HOADON
FOR INSERT
AS
BEGIN
	DECLARE @MaKH CHAR(10), @NgayHD smalldatetime, @NgayDK smalldatetime

	SELECT @NgayHD = NGHD, @MaKH = MAKH
	FROM inserted

	SELECT @NgayDK = NGDK
	FROM dbo.KHACHHANG
	WHERE @MaKH = MAKH

	IF (@NgayHD < @NgayDK)
		BEGIN 
			PRINT N'Ngày mua hàng không hợp lệ'
			ROLLBACK TRAN
		END
	ELSE
		BEGIN
			PRINT N'Thêm một hóa đơn thành công'
		END
END 
GO

--12--
CREATE TRIGGER TRG_INS_UPD_NGHD_NV
ON dbo.HOADON
FOR INSERT, UPDATE 
AS 
BEGIN
	DECLARE @MaNV CHAR(10), @NgayBH smalldatetime, @NgayVL char(10)

	SELECT @NgayBH = NGHD, @MaNV = MANV
	FROM inserted

	SELECT @NgayVL = NGVL 
	FROM dbo.NHANVIEN
	WHERE MANV = @MaNV

	IF (@NgayBH < @NgayVL)
		BEGIN
			PRINT N'Ngày bán hàng không hợp lệ'
			ROLLBACK TRAN
		END
	ELSE 
		BEGIN
			PRINT N'Thêm 1 hóa đơn thành công'
		END
END 
GO

--13--
CREATE TRIGGER TRG_UPD_TRIGIA 
ON dbo.CTHD
FOR INSERT
AS
BEGIN
	DECLARE @TongTien INT, @SoHD CHAR(10)

	SELECT @TongTien = SUM(SL * GIA), @SoHD = SOHD
	FROM inserted
	JOIN dbo.SANPHAM AS SP ON inserted.MASP = SP.MASP
	GROUP BY SOHD

	UPDATE dbo.HOADON
	SET TRIGIA += @TongTien
	WHERE SOHD = @SoHD
END
GO

CREATE TRIGGER TRG_DEL_TRIGIA
ON dbo.CTHD
FOR DELETE
AS 
BEGIN
	DECLARE @Tien INT, @SoHD CHAR(10)

	SELECT @SoHD = SOHD, @Tien = SL * GIA
	FROM deleted JOIN dbo.SANPHAM AS SP
	ON SP.MASP = deleted.MASP

	UPDATE HOADON
	SET TRIGIA -= @Tien
	WHERE SOHD = @SoHD
END 
GO

--14--
CREATE TRIGGER TRG_INS_UPD_DoanhSo 
ON dbo.HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @DoanhSo INT, @MaKH CHAR(10)

	SELECT @MaKH = MAKH, @DoanhSo = SUM(TRIGIA)
	FROM inserted
	GROUP BY MAKH

	UPDATE dbo.KHACHHANG
	SET DOANHSO += @DoanhSo
	WHERE MAKH = @MaKH
END
GO

----------
--II--
--1-- Nhập dữ liệu
SET DATEFORMAT DMY

-- Nhập data cho KHACHHANG
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH01', 'Nguyen Van A', '731, Tran Hung Dao, Q5, TPHCM', '08823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '03/04/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/06/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH04', 'Tran Minh Long', '50/34 Le Dai hanh, Q10, TpHCM', '0917325476', '09/03/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TPHCM', '08246108', '10/03/1960', 21000, '28/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '06/04/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TPHCM', '0938435756', '10/01/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TPHCM', '08654763', '03/09/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TPHCM', '08768904', '02/05/1963', 67500, '16/01/2007')

-- Nhập dữ liệu cho NHANVIEN
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV02', 'Le Thi Phi Yen', '0987567390', '21/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV03', 'Nguyen Van B', '0997047382', '27/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV04', 'Ngo Thanh Tuan', '0913758498', '24/6/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/7/2006')

-- Nhập dữ liệu cho SANPHAM
INSERT INTO SANPHAM VALUES('BC01','But chi','cay','Singapore',3000)
INSERT INTO SANPHAM VALUES('BC02','But chi','cay','Singapore',5000)
INSERT INTO SANPHAM VALUES('BC03','But chi','cay','Viet Nam',3500)
INSERT INTO SANPHAM VALUES('BC04','But chi','hop','Viet Nam',30000)
INSERT INTO SANPHAM VALUES('BB01','But bi','cay','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('BB02','But bi','cay','Trung Quoc',7000)
INSERT INTO SANPHAM VALUES('BB03','But bi','hop','Thai Lan',100000)
INSERT INTO SANPHAM VALUES('TV01','Tap 100 giay mong','quyen','Trung Quoc',2500)
INSERT INTO SANPHAM VALUES('TV02','Tap 200 giay mong','quyen','Trung Quoc',4500)
INSERT INTO SANPHAM VALUES('TV03','Tap 100 giay tot','quyen','Viet Nam',3000)
INSERT INTO SANPHAM VALUES('TV04','Tap 200 giay tot','quyen','Viet Nam',5500)
INSERT INTO SANPHAM VALUES('TV05','Tap 100 trang','chuc','Viet Nam',23000)
INSERT INTO SANPHAM VALUES('TV06','Tap 200 trang','chuc','Viet Nam',53000)
INSERT INTO SANPHAM VALUES('TV07','Tap 100 trang','chuc','Trung Quoc',34000)
INSERT INTO SANPHAM VALUES('ST01','So tay 500 trang','quyen','Trung Quoc',40000)
INSERT INTO SANPHAM VALUES('ST02','So tay loai 1','quyen','Viet Nam',55000)
INSERT INTO SANPHAM VALUES('ST03','So tay loai 2','quyen','Viet Nam',51000)
INSERT INTO SANPHAM VALUES('ST04','So tay','quyen','Thai Lan',55000)
INSERT INTO SANPHAM VALUES('ST05','So tay mong','quyen','Thai Lan',20000)
INSERT INTO SANPHAM VALUES('ST06','Phan viet bang','hop','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('ST07','Phan khong bui','hop','Viet Nam',7000)
INSERT INTO SANPHAM VALUES('ST08','Bong bang','cai','Viet Nam',1000)
INSERT INTO SANPHAM VALUES('ST09','But long','cay','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('ST10','But long','cay','Trung Quoc',7000)

-- Nhập dữ liệu cho HOADON
INSERT INTO HOADON VALUES(1001,'23/07/2006','KH01','NV01',320000)
INSERT INTO HOADON VALUES(1002,'12/08/2006','KH01','NV02',840000)
INSERT INTO HOADON VALUES(1003,'23/08/2006','KH02','NV01',100000)
INSERT INTO HOADON VALUES(1004,'01/09/2006','KH02','NV01',180000)
INSERT INTO HOADON VALUES(1005,'20/10/2006','KH01','NV02',3800000)
INSERT INTO HOADON VALUES(1006,'16/10/2006','KH01','NV03',2430000)
INSERT INTO HOADON VALUES(1007,'28/10/2006','KH03','NV03',510000)
INSERT INTO HOADON VALUES(1008,'28/10/2006','KH01','NV03',440000)
INSERT INTO HOADON VALUES(1009,'28/10/2006','KH03','NV04',200000)
INSERT INTO HOADON VALUES(1010,'01/11/2006','KH01','NV01',5200000)
INSERT INTO HOADON VALUES(1011,'04/11/2006','KH04','NV03',250000)
INSERT INTO HOADON VALUES(1012,'30/11/2006','KH05','NV03',21000)
INSERT INTO HOADON VALUES(1013,'12/12/2006','KH06','NV01',5000)
INSERT INTO HOADON VALUES(1014,'31/12/2006','KH03','NV02',3150000)
INSERT INTO HOADON VALUES(1015,'01/01/2007','KH06','NV01',910000)
INSERT INTO HOADON VALUES(1016,'01/01/2007','KH07','NV02',12500)
INSERT INTO HOADON VALUES(1017,'02/01/2007','KH08','NV03',35000)
INSERT INTO HOADON VALUES(1018,'13/01/2007','KH08','NV03',330000)
INSERT INTO HOADON VALUES(1019,'13/01/2007','KH01','NV03',30000)
INSERT INTO HOADON VALUES(1020,'14/01/2007','KH09','NV04',70000)
INSERT INTO HOADON VALUES(1021,'16/01/2007','KH10','NV03',67500)
INSERT INTO HOADON VALUES(1022,'16/01/2007',Null,'NV03',7000)
INSERT INTO HOADON VALUES(1023,'17/01/2007',Null,'NV01',330000)

-- Nhập dữ liệu cho CTHD
INSERT INTO CTHD VALUES(1001,'TV02',10)
INSERT INTO CTHD VALUES(1001,'ST01',5)
INSERT INTO CTHD VALUES(1001,'BC01',5)
INSERT INTO CTHD VALUES(1001,'BC02',10)
INSERT INTO CTHD VALUES(1001,'ST08',10)
INSERT INTO CTHD VALUES(1002,'BC04',20)
INSERT INTO CTHD VALUES(1002,'BB01',20)
INSERT INTO CTHD VALUES(1002,'BB02',20)
INSERT INTO CTHD VALUES(1003,'BB03',10)
INSERT INTO CTHD VALUES(1004,'TV01',20)
INSERT INTO CTHD VALUES(1004,'TV02',10)
INSERT INTO CTHD VALUES(1004,'TV03',10)
INSERT INTO CTHD VALUES(1004,'TV04',10)
INSERT INTO CTHD VALUES(1005,'TV05',50)
INSERT INTO CTHD VALUES(1005,'TV06',50)
INSERT INTO CTHD VALUES(1006,'TV07',20)
INSERT INTO CTHD VALUES(1006,'ST01',30)
INSERT INTO CTHD VALUES(1006,'ST02',10)
INSERT INTO CTHD VALUES(1007,'ST03',10)
INSERT INTO CTHD VALUES(1008,'ST04',8)
INSERT INTO CTHD VALUES(1009,'ST05',10)
INSERT INTO CTHD VALUES(1010,'TV07',50)
INSERT INTO CTHD VALUES(1010,'ST07',50)
INSERT INTO CTHD VALUES(1010,'ST08',100)
INSERT INTO CTHD VALUES(1010,'ST04',50)
INSERT INTO CTHD VALUES(1010,'TV03',100)
INSERT INTO CTHD VALUES(1011,'ST06',50)
INSERT INTO CTHD VALUES(1012,'ST07',3)
INSERT INTO CTHD VALUES(1013,'ST08',5)
INSERT INTO CTHD VALUES(1014,'BC02',80)
INSERT INTO CTHD VALUES(1014,'BB02',100)
INSERT INTO CTHD VALUES(1014,'BC04',60)
INSERT INTO CTHD VALUES(1014,'BB01',50)
INSERT INTO CTHD VALUES(1015,'BB02',30)
INSERT INTO CTHD VALUES(1015,'BB03',7)
INSERT INTO CTHD VALUES(1016,'TV01',5)
INSERT INTO CTHD VALUES(1017,'TV02',1)
INSERT INTO CTHD VALUES(1017,'TV03',1)
INSERT INTO CTHD VALUES(1017,'TV04',5)
INSERT INTO CTHD VALUES(1018,'ST04',6)
INSERT INTO CTHD VALUES(1019,'ST05',1)
INSERT INTO CTHD VALUES(1019,'ST06',2)
INSERT INTO CTHD VALUES(1020,'ST07',10)
INSERT INTO CTHD VALUES(1021,'ST08',5)
INSERT INTO CTHD VALUES(1021,'TV01',7)
INSERT INTO CTHD VALUES(1021,'TV02',10)
INSERT INTO CTHD VALUES(1022,'ST07',1)
INSERT INTO CTHD VALUES(1023,'ST04',6)

--2--
SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * INTO KHACHHANG1 FROM KHACHHANG

--3--
UPDATE SANPHAM1
SET GIA = 1.05 * GIA
WHERE NUOCSX = 'Thai Lan'

--4--
UPDATE SANPHAM1
SET GIA = 0.95 * GIA
WHERE NUOCSX = 'Trung Quoc' AND GIA <= 10000

--5--
UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE (NGDK < '1/1/2007' AND DOANHSO >= 10000000)
OR (NGDK >= '1/1/2007' AND DOANHSO >= 2000000)

--III--
--1--
SELECT MASP, TENSP FROM dbo.SANPHAM
WHERE NUOCSX = 'Trung Quoc'

--2--
SELECT MASP, TENSP FROM dbo.SANPHAM
WHERE DVT = 'cay' OR DVT = 'quyen'
-- DVT IN('cay', 'quyen')

--3--
SELECT MASP, TENSP FROM dbo.SANPHAM
WHERE MASP LIKE 'B%01' 

--4--
SELECT MASP, TENSP FROM dbo.SANPHAM
WHERE (NUOCSX = 'Trung Quoc') AND (GIA BETWEEN 30000 AND 40000)

--5--
SELECT MASP, TENSP FROM dbo.SANPHAM
WHERE 
	NUOCSX IN('Trung Quoc', 'Thai Lan')
	AND
	GIA BETWEEN 30000 AND 40000

--6--
SELECT SOHD, TRIGIA FROM dbo.HOADON
WHERE NGHD IN('1/1/2007', '2/1/2007')

--7--
SELECT SOHD, TRIGIA FROM dbo.HOADON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY NGHD ASC, TRIGIA DESC

--8--
SELECT KH.MAKH, KH.HOTEN 
FROM dbo.KHACHHANG AS KH 
JOIN dbo.HOADON AS HD ON KH.MAKH = HD.MAKH
WHERE HD.NGHD = '1/1/2007'
GROUP BY KH.MAKH, KH.HOTEN

--9--
SELECT HOADON.SOHD, HOADON.TRIGIA
FROM dbo.NHANVIEN 
JOIN dbo.HOADON ON NHANVIEN.MANV = HOADON.MANV
WHERE 
	NHANVIEN.HOTEN = 'Nguyen Van B'
	AND HOADON.NGHD = '28/10/2006'

--10--
SELECT SANPHAM.MASP, SANPHAM.TENSP
FROM dbo.KHACHHANG 
JOIN dbo.HOADON ON KHACHHANG.MAKH = HOADON.MAKH
JOIN dbo.CTHD ON CTHD.SOHD = HOADON.SOHD
JOIN dbo.SANPHAM ON SANPHAM.MASP = CTHD.MASP
WHERE 
	KHACHHANG.HOTEN = 'Nguyen Van A'
	AND
	MONTH(HOADON.NGHD) = 10 AND YEAR(HOADON.NGHD) = 2006

--11--
SELECT DISTINCT SOHD FROM dbo.CTHD
WHERE MASP IN('BB01', 'BB02')

--12--
SELECT DISTINCT SOHD
FROM dbo.CTHD
WHERE 
	MASP IN('BB01', 'BB02')
	AND
	SL BETWEEN 10 AND 20

--13--
SELECT DISTINCT SOHD
FROM dbo.CTHD
WHERE 
	MASP = 'BB01'
	AND
	SL BETWEEN 10 AND 20
INTERSECT (
	SELECT DISTINCT SOHD
	FROM dbo.CTHD
	WHERE 
		MASP = 'BB02'
		AND
		SL BETWEEN 10 AND 20
)

--14--
SELECT SANPHAM.MASP, TENSP
FROM dbo.SANPHAM
JOIN dbo.CTHD ON SANPHAM.MASP = CTHD.MASP
JOIN dbo.HOADON ON HOADON.SOHD = CTHD.SOHD
WHERE 
	NUOCSX = 'Trung Quoc'
	OR
	NGHD = '1/1/2007'

--15--
SELECT MASP, TENSP
FROM dbo.SANPHAM
EXCEPT (
	SELECT SANPHAM.MASP, TENSP
	FROM dbo.SANPHAM 
	JOIN dbo.CTHD ON SANPHAM.MASP = CTHD.MASP
)

--16--
SELECT MASP, TENSP
FROM dbo.SANPHAM
EXCEPT (
	SELECT SANPHAM.MASP, TENSP
	FROM dbo.SANPHAM 
	JOIN dbo.CTHD ON SANPHAM.MASP = CTHD.MASP
	JOIN dbo.HOADON ON HOADON.SOHD = CTHD.SOHD
	WHERE YEAR(NGHD) = 2006
)

--17--
SELECT MASP, TENSP
FROM dbo.SANPHAM 
WHERE NUOCSX = 'Trung Quoc'
EXCEPT (
	SELECT SANPHAM.MASP, TENSP
	FROM dbo.SANPHAM 
	JOIN dbo.CTHD ON SANPHAM.MASP = CTHD.MASP
	JOIN dbo.HOADON ON HOADON.SOHD = CTHD.SOHD
	WHERE 
		YEAR(NGHD) = 2006
)


--18--
SELECT HD.SOHD
FROM dbo.HOADON AS HD
WHERE YEAR(HD.NGHD) = 2006
AND NOT EXISTS (
	SELECT *
	FROM dbo.SANPHAM AS SP
	WHERE NUOCSX = 'Singapore' --danh sách các sản phẩm do Singapore sản xuất
	AND NOT EXISTS (
		SELECT *
		FROM dbo.CTHD
		WHERE CTHD.SOHD = HD.SOHD
		AND CTHD.MASP = SP.MASP
	) --xác định xem sản phẩm này có trong CTHD không
)

--19--
SELECT COUNT(SOHD) AS SoHD
FROM dbo.HOADON
WHERE MAKH IS NULL

--20--
SELECT COUNT(DISTINCT MASP) AS SoSPBanRa
FROM dbo.CTHD, dbo.HOADON
WHERE CTHD.SOHD = HOADON.SOHD
	AND YEAR(NGHD) = 2006

--21--
SELECT MAX(TRIGIA) AS MaxTriGia, MIN(TRIGIA) as MinTriGia
FROM dbo.HOADON

--22--
SELECT AVG(TRIGIA) AS TriGiaTrungBinh
FROM dbo.HOADON
WHERE YEAR(NGHD) = 2006

--23--
SELECT SUM(TRIGIA) AS DOANHTHU
FROM dbo.HOADON
WHERE YEAR(NGHD) = 2006

--24--
SELECT MAX(TRIGIA) AS MaxTriGia2006
FROM dbo.HOADON
WHERE YEAR(NGHD) = 2006

--25--
SELECT KH.HOTEN
FROM dbo.KHACHHANG AS KH JOIN dbo.HOADON AS HD
ON KH.MAKH = HD.MAKH
WHERE HD.TRIGIA = (
	SELECT MAX(TRIGIA) AS MaxTriGia2006
	FROM dbo.HOADON
	WHERE YEAR(NGHD) = 2006
)

--26--
SELECT TOP 3 WITH TIES KHACHHANG.MAKH, HOTEN
FROM dbo.KHACHHANG
ORDER BY DOANHSO DESC

--27--
SELECT MASP, TENSP
FROM dbo.SANPHAM
WHERE GIA IN (
	SELECT TOP 3 GIA
	FROM dbo.SANPHAM
	ORDER BY GIA DESC
)

--28--
SELECT MASP, TENSP
FROM dbo.SANPHAM
WHERE NUOCSX = 'Thai Lan'
	AND GIA IN (
	SELECT TOP 3 GIA
	FROM dbo.SANPHAM
	ORDER BY GIA DESC
)

--29--
SELECT MASP, TENSP
FROM dbo.SANPHAM
WHERE NUOCSX = 'Trung Quoc'
	AND GIA IN (
	SELECT TOP 3 GIA
	FROM dbo.SANPHAM
	WHERE NUOCSX = 'Trung Quoc'
	ORDER BY GIA DESC
)

--30--
SELECT DISTINCT TOP 3 MAKH, HOTEN,
DENSE_RANK() OVER (ORDER BY DOANHSO DESC) AS ThuHangDoanhSo
FROM dbo.KHACHHANG
ORDER BY ThuHangDoanhSo

--31-- 
SELECT COUNT(MASP) AS SPTQSX
FROM dbo.SANPHAM
WHERE NUOCSX = 'Trung Quoc'

--32--
SELECT NUOCSX, COUNT(MASP) AS SoSanPham
FROM dbo.SANPHAM
GROUP BY NUOCSX

--33--
SELECT NUOCSX, MAX(GIA) AS MaxGia, MIN(GIA) AS MinGia, AVG(GIA) AS GIATB
FROM dbo.SANPHAM
GROUP BY NUOCSX

--34--
SELECT NGHD, SUM(TRIGIA) AS DOANHTHU
FROM dbo.HOADON
GROUP BY NGHD

--35--
SELECT MASP, SUM(CTHD.SL) AS SOLUONG
FROM dbo.HOADON AS HD
JOIN dbo.CTHD ON HD.SOHD = CTHD.SOHD
WHERE MONTH(HD.NGHD) = 10 AND YEAR(HD.NGHD) = 2006
GROUP BY MASP

--36--
SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS DOANHTHU
FROM dbo.HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

--37--
SELECT SOHD
FROM dbo.CTHD
GROUP BY SOHD
HAVING COUNT(DISTINCT MASP) >= 4

--38--
SELECT CTHD.SOHD
FROM dbo.SANPHAM AS SP
JOIN dbo.CTHD ON CTHD.MASP = SP.MASP
WHERE SP.NUOCSX = 'Viet Nam'
GROUP BY CTHD.SOHD
HAVING COUNT(DISTINCT CTHD.MASP) >= 3

--39--
SELECT KH.MAKH, HOTEN
FROM dbo.KHACHHANG AS KH
JOIN dbo.HOADON AS HD ON KH.MAKH = HD.MAKH
GROUP BY KH.MAKH, HOTEN
HAVING COUNT(HD.MAKH) >= ALL(
	SELECT COUNT(HOADON.MAKH)
	FROM dbo.HOADON
	GROUP BY HOADON.MAKH
)

--40--
SELECT MONTH(NGHD) DSBH_MAX
FROM dbo.HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)
HAVING SUM(TRIGIA) >= ALL(
	SELECT SUM(TRIGIA)
	FROM dbo.HOADON
	WHERE YEAR(NGHD)= 2006
	GROUP BY MONTH(HOADON.NGHD)
)

--41--
SELECT TOP 1 SP.MASP, TENSP
FROM dbo.SANPHAM AS SP
JOIN dbo.CTHD ON SP.MASP = CTHD.MASP
JOIN dbo.HOADON AS HD ON HD.SOHD = CTHD.SOHD
WHERE YEAR(NGHD) = 2006
GROUP BY SP.MASP, TENSP
ORDER BY SUM(SL) ASC

--42--
SELECT NUOCSX, MASP, TENSP
FROM dbo.SANPHAM AS SP1
WHERE EXISTS (
	SELECT NUOCSX
	FROM dbo.SANPHAM AS SP2
	GROUP BY NUOCSX
	HAVING SP1.NUOCSX = SP2.NUOCSX
		AND SP1.GIA = MAX(SP2.GIA)
)

--43--
SELECT NUOCSX
FROM dbo.SANPHAM SP1
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA) >= 3

--44--
--C1----
WITH MuaHangNhieuNhat AS (
	SELECT MAKH
	FROM dbo.HOADON 
	GROUP BY MAKH
	HAVING COUNT(MAKH) >= ALL (
		SELECT COUNT(MAKH)
		FROM dbo.HOADON
		GROUP BY MAKH
	)
),
DoanhSoCaoNhat AS(
	SELECT TOP 10 WITH TIES MAKH, SUM(TRIGIA) AS TONGTRIGIA
	FROM dbo.HOADON
	GROUP BY MAKH
	ORDER BY TONGTRIGIA DESC
)

SELECT * 
FROM dbo.KHACHHANG
WHERE MAKH IN (
	SELECT MAKH
	FROM MuaHangNhieuNhat
	WHERE MAKH IN (
		SELECT MAKH 
		FROM DoanhSoCaoNhat
	)
)
------

--C2
SELECT *
FROM dbo.KHACHHANG
WHERE MAKH IN (
	SELECT TOP 1 WITH TIES HD.MAKH
	FROM (
		SELECT TOP 10 MAKH
		FROM dbo.HOADON
		ORDER BY TRIGIA DESC
	) AS A
	JOIN dbo.HOADON AS HD 
	ON A.MAKH = HD.MAKH
	GROUP BY HD.MAKH
	ORDER BY COUNT(HD.MAKH) DESC
)
-------




